# Z-Reader 工作流概述

## 核心工作流

### 1. RSS 订阅与内容抓取

用户添加 RSS 订阅后，系统自动定时抓取并解析文章内容。

```mermaid
sequenceDiagram
    participant 用户
    participant 渲染进程
    participant IPC
    participant FeedHandlers as Feed 处理器
    participant RSSService as RSS 服务
    participant ParserService as 解析服务
    participant DB as SQLite

    用户->>渲染进程: 输入 RSS URL / 导入 OPML
    渲染进程->>IPC: feedAdd / feedImportOpml
    IPC->>FeedHandlers: 验证并保存订阅源
    FeedHandlers->>DB: INSERT INTO feeds
    FeedHandlers->>RSSService: 立即抓取
    RSSService->>RSSService: rss-parser 解析 XML
    RSSService->>ParserService: 提取正文内容
    ParserService-->>RSSService: 结构化文本
    RSSService->>DB: INSERT INTO articles
    RSSService-->>渲染进程: 刷新列表

    Note over RSSService: 每 15 分钟定时抓取
    loop 定时任务
        RSSService->>RSSService: fetchAllFeeds()
        RSSService->>DB: 差量更新（基于 guid 去重）
    end
```

**关键细节：**
- 使用 `ETag` / `Last-Modified` 避免重复抓取
- 检测 Podcast 类型（`itunes:*` 命名空间），区分文章与播客
- 解析失败时降级为原始 HTML 模式
- 支持 `content:encoded`、`yt:videoId` 等自定义字段

### 2. 文章阅读与高亮标注

```mermaid
sequenceDiagram
    participant 用户
    participant ContentList as 内容列表
    participant ReaderView as 阅读器
    participant HLEngine as 高亮引擎
    participant IPC
    participant DB as SQLite

    用户->>ContentList: 点击文章 / J/K 导航
    ContentList->>IPC: articleGet(id)
    IPC-->>ReaderView: 文章 HTML 内容
    ReaderView->>ReaderView: 渲染文章 + 已有高亮

    用户->>ReaderView: 选中文本 / 按 H
    ReaderView->>HLEngine: 计算选区偏移量
    HLEngine->>HLEngine: 生成锚点路径 + 段落索引
    HLEngine-->>ReaderView: HighlightInput 数据
    ReaderView->>IPC: highlightCreate(input)
    IPC->>DB: INSERT INTO highlights
    DB-->>ReaderView: 高亮 ID
    ReaderView->>ReaderView: 渲染高亮覆盖层

    用户->>ReaderView: 点击高亮 → 添加注释
    ReaderView->>IPC: highlightUpdate(id, {note})
    IPC->>DB: UPDATE highlights

    用户->>ReaderView: 为高亮添加标签
    ReaderView->>IPC: highlightTagAdd(highlightId, tagId)
    IPC->>DB: INSERT INTO highlight_tags
```

**高亮引擎工作原理 (`highlight-engine.ts`)：**
1. 捕获文本选区 (`Selection` API)
2. 计算 DOM 锚点路径和字符偏移量
3. 序列化为可持久化的位置信息
4. 还原时根据锚点路径定位 DOM 节点
5. 使用 `AnnotationLayer` 组件渲染半透明覆盖层

### 3. Feed-Library 内容分流

```mermaid
flowchart TB
    NewArticle["新文章抓取"]
    Feed["Feed 区<br/>（收件箱）"]
    Library["Library 区<br/>（个人知识库）"]
    Archive["归档"]
    Delete["删除"]
    Later["稍后阅读"]
    Shortlist["精选"]

    NewArticle -->|自动落入| Feed
    Feed -->|"S (加入精选)"| Shortlist
    Feed -->|"L (稍后读)"| Later
    Feed -->|"E (归档)"| Archive
    Feed -->|"D (删除)"| Delete
    Feed -->|主动保存| Library

    Library -->|"E (归档)"| Archive
    Library -->|"D (删除)"| Delete
    Library -->|"S (加入精选)"| Shortlist

    Shortlist -->|"E (归档)"| Archive
    Later -->|阅读完成| Archive
    Delete -->|恢复| Feed

    style Feed fill:#3B82F6,color:#fff
    style Library fill:#8B5CF6,color:#fff
    style Archive fill:#6B7280,color:#fff
    style Shortlist fill:#F59E0B,color:#000
    style Later fill:#10B981,color:#fff
    style Delete fill:#EF4444,color:#fff
```

**状态流转规则：**

| 操作 | 快捷键 | 说明 |
|------|-------|------|
| 归档 | `E` | 标记已读完，移出视线 |
| 删除 | `D` | 移入废纸篓 |
| 稍后读 | `L` | 推入稍后阅读队列 |
| 精选 | `S` | 标记高优先级 |
| 撤销 | `Z` | 回退上一步操作 |
| 批量操作 | `Shift+选择` | 批量执行上述操作 |

### 4. AI 智能分析

```mermaid
sequenceDiagram
    participant 用户
    participant ChatPanel as AI 对话面板
    participant IPC
    participant AIHandlers as AI 处理器
    participant ChatService as 聊天服务
    participant LLM as LLM 供应商
    participant Tools as AI 工具
    participant DB as SQLite

    用户->>ChatPanel: 输入问题 / 选择预设
    ChatPanel->>IPC: aiChatSend(sessionId, message)
    IPC->>AIHandlers: 路由到聊天处理器
    AIHandlers->>ChatService: 创建/继续会话

    ChatService->>LLM: 发送消息（含工具定义）
    LLM-->>ChatService: 流式响应 / 工具调用

    alt 工具调用
        ChatService->>Tools: 执行工具（搜索/标签/高亮等）
        Tools->>DB: 查询或修改数据
        DB-->>Tools: 返回结果
        Tools-->>ChatService: 工具执行结果
        ChatService->>LLM: 提交工具结果，继续生成
    end

    loop 流式输出
        ChatService-->>IPC: ChatStreamChunk
        IPC-->>ChatPanel: 实时渲染文本
    end

    ChatService->>DB: 保存会话和消息
```

**AI 工具体系：**

```mermaid
graph TB
    subgraph AITools["AI 工具集"]
        ArticleTools["文章工具<br/>searchArticles<br/>getArticleContent<br/>markAsRead<br/>archiveArticle"]
        TagTools["标签工具<br/>listTags<br/>addTag<br/>removeTag"]
        FeedTools["订阅工具<br/>listFeeds<br/>getReadingStats"]
        HighlightTools["高亮工具<br/>listHighlights<br/>createHighlight"]
    end

    subgraph AISkills["AI 技能"]
        Summarize["摘要生成"]
        Translate["翻译"]
        AutoTag["自动标签"]
        ExtractTopics["主题提取"]
    end

    subgraph Providers["LLM 供应商"]
        OpenRouter["OpenRouter<br/>Claude Sonnet / Gemini Flash"]
        Minimax["Minimax"]
    end

    AISkills --> Providers
    AITools --> Providers
```

### 5. 播客收听与转录

```mermaid
sequenceDiagram
    participant 用户
    participant PodcastReader as 播客播放器
    participant AudioPlayer as 音频组件
    participant IPC
    participant ASRHandlers as ASR 处理器
    participant ASRService as ASR 服务
    participant AudioPipeline as 音频管线
    participant ASRProvider as ASR 供应商

    用户->>PodcastReader: 选择播客集
    PodcastReader->>AudioPlayer: 加载音频 URL
    AudioPlayer->>AudioPlayer: 播放/暂停/倍速/进度

    用户->>PodcastReader: 请求转录
    PodcastReader->>IPC: asrStart(articleId)
    IPC->>ASRHandlers: 启动转录任务
    ASRHandlers->>AudioPipeline: 提取音频
    AudioPipeline->>AudioPipeline: ffmpeg 处理
    AudioPipeline-->>ASRService: 音频数据

    loop 流式识别
        ASRService->>ASRProvider: 发送音频片段
        ASRProvider-->>ASRService: 识别结果
        ASRService-->>IPC: asrSegment (时间码 + 文本)
        IPC-->>PodcastReader: 实时显示字幕
    end

    ASRService->>IPC: asrComplete
    IPC->>DB: 保存转录 (transcripts 表)
    PodcastReader->>PodcastReader: 渲染完整时间线
```

**播客播放器功能：**
- 音频播放控制（播放/暂停/进度/音量）
- 倍速播放（0.5x - 3x）
- 章节导航
- 时间戳字幕同步显示
- 前进/后退 30 秒

### 6. iCloud 同步

```mermaid
sequenceDiagram
    participant 设备A as 设备 A
    participant ChangeTracker as 变更追踪器
    participant SyncEngine as 同步引擎
    participant iCloud as iCloud Drive
    participant 设备B as 设备 B

    Note over 设备A: 用户操作产生数据变更
    设备A->>ChangeTracker: 记录变更
    ChangeTracker->>ChangeTracker: 追踪未同步的修改

    设备A->>SyncEngine: push()
    SyncEngine->>SyncEngine: 检测 iCloud 路径
    SyncEngine->>SyncEngine: 写入设备快照
    SyncEngine->>iCloud: 写入 changelog 文件

    Note over iCloud: iCloud 自动同步文件

    设备B->>SyncEngine: pull()
    SyncEngine->>iCloud: 读取其他设备 changelog
    SyncEngine->>SyncEngine: 合并策略（时间戳优先）
    SyncEngine->>设备B: 应用远程变更

    Note over SyncEngine: 冲突解决策略
    SyncEngine->>SyncEngine: 最新时间戳优先
    SyncEngine->>SyncEngine: 创建优先于删除
```

**同步架构组件：**

| 组件 | 职责 |
|------|------|
| `sync-engine.ts` | 编排 push/pull 流程 |
| `change-tracker.ts` | 追踪本地未同步变更 |
| `changelog-writer.ts` | 序列化变更到文件 |
| `changelog-reader.ts` | 读取远程设备变更 |
| `merge-strategy.ts` | 冲突解决策略 |
| `snapshot-manager.ts` | 数据库快照管理 |
| `device-identity.ts` | 设备唯一标识 |
| `icloud-detector.ts` | iCloud 路径检测 |

### 7. 电子书阅读

```mermaid
flowchart TB
    Upload["上传电子书<br/>（拖拽/选择文件）"]
    Detect["检测文件类型"]
    EPUB["EPUB 处理"]
    PDF["PDF 处理"]

    Upload --> Detect
    Detect -->|.epub| EPUB
    Detect -->|.pdf| PDF

    subgraph EPUBFlow["EPUB 阅读流程"]
        EPUBParse["epubjs 解析"]
        EPUBRender["章节渲染"]
        EPUBCFI["CFI 定位系统"]
        EPUBProgress["阅读进度保存"]
    end

    subgraph PDFFlow["PDF 阅读流程"]
        PDFParse["pdfjs-dist 解析"]
        PDFRender["页面渲染<br/>（Canvas/文本层）"]
        PDFZoom["缩放控制<br/>（触控板手势）"]
        PDFText["文本提取视图"]
    end

    EPUB --> EPUBFlow
    PDF --> PDFFlow

    EPUBFlow -->|高亮标注| HL["高亮系统<br/>（复用文章高亮引擎）"]
    PDFFlow -->|高亮标注| HL
```

### 8. 分享卡片生成

```mermaid
flowchart LR
    Select["选择高亮/文章"]
    Modal["打开分享卡片"]
    Theme["选择主题"]
    Preview["预览卡片"]
    Export["导出"]

    Select --> Modal --> Theme --> Preview --> Export

    subgraph Themes["可选主题"]
        Swiss["瑞士设计"]
        Minimal["极简"]
        InkWash["水墨"]
        Cyber["赛博朋克"]
        Riso["孔版印刷"]
    end

    subgraph CardTypes["卡片类型"]
        Single["单条高亮"]
        Multi["多条高亮"]
        Summary["文章摘要"]
    end

    subgraph ExportFormats["导出方式"]
        Clipboard["复制到剪贴板"]
        Image["保存为图片"]
    end

    Theme --> Themes
    Modal --> CardTypes
    Export --> ExportFormats
```

## 数据流全景

```mermaid
flowchart TB
    subgraph Sources["内容源"]
        RSS["RSS/Atom"]
        YT["YouTube"]
        Pod["播客"]
        Web["网页 URL"]
        Book["电子书"]
        NL["Newsletter"]
        Chrome["Chrome 扩展"]
    end

    subgraph Ingest["内容摄入"]
        RSSParser["RSS 解析器"]
        YTService["YouTube 服务"]
        PodResolver["播客解析器"]
        WebParser["正文提取器"]
        BookParser["电子书解析"]
        NLService["邮件服务"]
        ChromeAPI["REST API"]
    end

    subgraph Storage["存储层"]
        SQLite["SQLite 数据库<br/>14 张表"]
        Files["本地文件<br/>EPUB/PDF/音频"]
    end

    subgraph Processing["处理层"]
        AI["AI 分析<br/>摘要/翻译/标签"]
        ASR["语音转文字"]
        Search["全文搜索"]
        Stats["阅读统计"]
    end

    subgraph Output["输出"]
        UI["桌面 UI"]
        ShareCards["分享卡片"]
        HLExport["高亮导出"]
        Sync["iCloud 同步"]
    end

    Sources --> Ingest --> Storage
    Storage --> Processing
    Storage --> Output
    Processing --> Storage

    style Sources fill:#3B82F6,color:#fff
    style Ingest fill:#8B5CF6,color:#fff
    style Storage fill:#F59E0B,color:#000
    style Processing fill:#10B981,color:#fff
    style Output fill:#EF4444,color:#fff
```

## 状态管理

Z-Reader 采用 **React 内置状态管理** 方案（无 Redux/Zustand），状态分布如下：

| 状态层级 | 管理方式 | 典型数据 |
|---------|---------|---------|
| 全局应用状态 | `App.tsx` 中的 `useState` + 回调传递 | 当前视图模式、选中文章、Modal 状态 |
| 组件局部状态 | 组件内 `useState` | 表单输入、展开/折叠、加载状态 |
| 服务端数据 | IPC 调用 + 手动刷新 | 文章列表、标签、订阅源 |
| 撤销栈 | `useUndoStack` Hook | 操作历史记录 |
| 面板尺寸 | `useResizablePanel` Hook | 拖拽调整的列宽 |

## 错误处理

```mermaid
flowchart TB
    Error["错误发生"]
    
    Error --> ParseError["解析错误"]
    Error --> NetworkError["网络错误"]
    Error --> DBError["数据库错误"]
    Error --> AIError["AI 调用错误"]

    ParseError -->|降级| RawHTML["显示原始 HTML"]
    ParseError -->|记录| ErrCount["errorCount + 1"]

    NetworkError -->|重试| Retry["自动重试"]
    NetworkError -->|离线| Offline["离线模式继续"]

    DBError -->|恢复| Snapshot["从快照恢复"]
    DBError -->|通知| UserNotify["通知用户"]

    AIError -->|降级| NoAI["跳过 AI 功能"]
    AIError -->|日志| TaskLog["记录到 ai_task_logs"]
```

## 国际化

支持中英文双语界面：
- `src/locales/zh.json` - 中文
- `src/locales/en.json` - 英文
- 使用 `i18next` + `react-i18next` 框架
- 语言检测：`i18next-browser-languagedetector`
