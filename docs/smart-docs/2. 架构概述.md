# Z-Reader 架构概述

## 系统上下文 (C4 Level 1)

Z-Reader 作为桌面应用运行在用户本地，与多个外部系统交互以获取和处理内容。

```mermaid
graph TB
    User["用户"]
    ZReader["Z-Reader<br/>Electron 桌面应用"]
    RSS["RSS/Atom 源<br/>（外部网站）"]
    YouTube["YouTube<br/>视频平台"]
    Podcast["播客平台<br/>iTunes/PodcastIndex"]
    RSSHub["RSSHub<br/>RSS 路由服务"]
    LLM["LLM 服务<br/>OpenRouter/Minimax"]
    ASR["语音识别服务<br/>火山引擎/腾讯云"]
    iCloud["iCloud Drive<br/>多设备同步"]
    Newsletter["邮件服务<br/>Newsletter 订阅"]
    ChromeExt["Chrome 扩展<br/>网页高亮"]

    User -->|阅读、标注、管理| ZReader
    ZReader -->|抓取 RSS/Atom 订阅| RSS
    ZReader -->|获取视频流与字幕| YouTube
    ZReader -->|搜索与订阅播客| Podcast
    ZReader -->|发现 RSS 源| RSSHub
    ZReader -->|AI 分析与摘要| LLM
    ZReader -->|语音转文字| ASR
    ZReader <-->|增量同步| iCloud
    ZReader -->|接收邮件订阅| Newsletter
    ChromeExt -->|保存高亮与文章| ZReader

    style ZReader fill:#4F46E5,color:#fff,stroke:#312E81
    style User fill:#059669,color:#fff
```

## 容器架构 (C4 Level 2)

Z-Reader 基于 Electron 的多进程架构，分为主进程、渲染进程和预加载桥接三大核心容器。

```mermaid
graph TB
    subgraph Electron["Electron 应用"]
        subgraph Main["主进程 (Main Process)"]
            DB["SQLite 数据库<br/>better-sqlite3 + Drizzle ORM"]
            IPC["IPC 处理器<br/>20+ 处理模块"]
            Services["业务服务层<br/>RSS/解析/同步/ASR"]
            AIModule["AI 模块<br/>LLM/工具/技能"]
            APIServer["API 服务器<br/>REST 接口"]
        end

        subgraph Preload["Preload 桥接"]
            Bridge["contextBridge<br/>electronAPI 暴露"]
        end

        subgraph Renderer["渲染进程 (Renderer Process)"]
            React["React 19 应用"]
            Components["47+ UI 组件"]
            Hooks["自定义 Hooks"]
            HLEngine["高亮引擎"]
        end
    end

    Renderer -->|invoke / send / on| Bridge
    Bridge -->|ipcRenderer| IPC
    IPC --> Services
    IPC --> AIModule
    Services --> DB
    AIModule --> DB

    style Main fill:#1E40AF,color:#fff
    style Renderer fill:#7C3AED,color:#fff
    style Preload fill:#047857,color:#fff
```

## 组件架构 (C4 Level 3)

### 主进程组件关系

```mermaid
graph TB
    subgraph MainProcess["主进程"]
        MainEntry["main.ts<br/>应用入口"]

        subgraph DBLayer["数据库层"]
            Schema["schema.ts<br/>14 张表定义"]
            DBInit["index.ts<br/>连接初始化"]
        end

        subgraph IPCLayer["IPC 处理器层"]
            FeedH["feed-handlers"]
            ArticleH["article-handlers"]
            HighlightH["highlight-handlers"]
            TagH["tag-handlers"]
            BookH["book-handlers"]
            TranscriptH["transcript-handlers"]
            AIH["ai-handlers"]
            ASRH["asr-handlers"]
            SyncH["sync-handlers"]
            DiscoverH["discover-handlers"]
            ShareH["share-card-handlers"]
            OtherH["其他处理器..."]
        end

        subgraph ServiceLayer["服务层"]
            RSSService["rss-service<br/>RSS 抓取与解析"]
            ParserService["parser-service<br/>正文提取"]
            YouTubeService["youtube-service<br/>视频处理"]
            PodcastService["podcast-resolver<br/>播客解析"]
            NewsletterService["newsletter-service<br/>邮件订阅"]
            RSSHubService["rsshub-service<br/>RSS 发现"]
            DownloadService["download-service<br/>下载管理"]
            SettingsService["settings-service<br/>设置管理"]
            NotificationService["notification-service<br/>通知"]
            TaskService["task-service<br/>任务跟踪"]
            TranscriptionService["transcription-source<br/>转录"]
        end

        subgraph SyncLayer["同步层"]
            SyncEngine["sync-engine<br/>同步编排"]
            ChangeTracker["change-tracker<br/>变更追踪"]
            ChangelogWriter["changelog-writer<br/>变更写入"]
            ChangelogReader["changelog-reader<br/>变更读取"]
            MergeStrategy["merge-strategy<br/>冲突解决"]
            SnapshotManager["snapshot-manager<br/>快照管理"]
            DeviceIdentity["device-identity<br/>设备标识"]
            iCloudDetector["icloud-detector<br/>iCloud 检测"]
        end

        subgraph ASRLayer["ASR 层"]
            ASRProvider["asr-provider<br/>基础接口"]
            VolcProvider["volcengine-provider<br/>火山引擎"]
            TencentProvider["tencent-provider<br/>腾讯云"]
            AudioPipeline["audio-pipeline<br/>音频处理"]
        end
    end

    MainEntry --> DBLayer
    MainEntry --> IPCLayer
    IPCLayer --> ServiceLayer
    IPCLayer --> SyncLayer
    IPCLayer --> ASRLayer
    ServiceLayer --> DBLayer
    SyncLayer --> DBLayer

    style MainProcess fill:#0F172A,color:#fff
    style DBLayer fill:#1E40AF,color:#fff
    style IPCLayer fill:#7C3AED,color:#fff
    style ServiceLayer fill:#047857,color:#fff
    style SyncLayer fill:#B45309,color:#fff
    style ASRLayer fill:#DC2626,color:#fff
```

### 渲染进程组件关系

```mermaid
graph TB
    subgraph RendererProcess["渲染进程"]
        App["App.tsx<br/>根组件 + 全局状态"]

        subgraph Layout["三栏布局"]
            Sidebar["Sidebar<br/>导航栏"]
            ContentList["ContentList<br/>内容列表"]
            DetailPanel["DetailPanel<br/>详情面板"]
        end

        subgraph Readers["阅读器"]
            ReaderView["ReaderView<br/>文章阅读"]
            EpubReader["EpubReader<br/>EPUB 阅读"]
            PdfReader["PdfReader<br/>PDF 阅读"]
            PdfTextView["PdfTextView<br/>PDF 文本视图"]
            VideoReader["VideoReaderView<br/>视频播放"]
            PodcastReader["PodcastReaderView<br/>播客播放"]
        end

        subgraph Dialogs["对话框"]
            AddFeed["AddFeedDialog<br/>添加订阅"]
            AddUrl["AddUrlDialog<br/>保存 URL"]
            Preferences["PreferencesDialog<br/>偏好设置"]
            FeedManage["FeedManageDialog<br/>订阅管理"]
        end

        subgraph Features["功能组件"]
            CommandPalette["CommandPalette<br/>命令面板"]
            SearchPanel["SearchPanel<br/>搜索"]
            ChatPanel["ChatPanel<br/>AI 对话"]
            AIDebug["AIDebugPanel<br/>AI 调试"]
            DownloadMgr["DownloadManager<br/>下载管理"]
            ShareCard["ShareCardModal<br/>分享卡片"]
        end

        subgraph Discover["发现页"]
            DiscoverPage["DiscoverPage<br/>内容发现"]
            SearchResults["SearchResults<br/>搜索结果"]
            FeedPreview["FeedPreview<br/>订阅预览"]
            CategoryGrid["CategoryGrid<br/>分类浏览"]
        end

        subgraph Common["通用组件"]
            ArticleCard["ArticleCard<br/>文章卡片"]
            TagPicker["TagPicker<br/>标签选择"]
            AnnotationLayer["AnnotationLayer<br/>高亮层"]
            Toast["Toast<br/>提示"]
            ContextMenu["ContextMenu<br/>右键菜单"]
        end

        HLEngine["highlight-engine<br/>高亮引擎"]
    end

    App --> Layout
    App --> Dialogs
    App --> Features
    App --> Discover
    Layout --> Readers
    Readers --> HLEngine
    Readers --> Common

    style RendererProcess fill:#0F172A,color:#fff
    style Layout fill:#1E40AF,color:#fff
    style Readers fill:#7C3AED,color:#fff
    style Dialogs fill:#047857,color:#fff
    style Features fill:#B45309,color:#fff
    style Discover fill:#DC2626,color:#fff
    style Common fill:#6B7280,color:#fff
```

## 架构模式

### 1. Electron 多进程架构

Z-Reader 严格遵循 Electron 的安全最佳实践：

- **主进程**：负责数据库操作、文件系统访问、网络请求、系统级功能
- **渲染进程**：纯 UI 渲染与交互，不直接访问 Node.js API
- **Preload 桥接**：通过 `contextBridge` 暴露安全的 `electronAPI` 接口
- **IPC 通信**：所有数据流通过 IPC 通道传递，确保进程隔离

### 2. 分层服务架构

```
┌─────────────────────────────┐
│  渲染进程 (React UI 层)       │
├─────────────────────────────┤
│  Preload 桥接层               │
├─────────────────────────────┤
│  IPC 处理器层 (路由分发)       │
├─────────────────────────────┤
│  业务服务层 (核心逻辑)         │
├─────────────────────────────┤
│  数据访问层 (Drizzle ORM)     │
├─────────────────────────────┤
│  SQLite 数据库                │
└─────────────────────────────┘
```

### 3. 本地优先 (Local-First) 架构

- 所有数据存储在本地 SQLite，即时生效
- 断网无损：全部功能离线可用
- 增量同步：通过 iCloud 文件系统实现设备间同步
- 冲突解决：基于时间戳的合并策略

### 4. 事件驱动的流式通信

对于 AI 聊天和 ASR 识别等需要流式输出的场景，采用事件驱动模式：
- 渲染进程通过 `send()` 发起请求
- 主进程通过事件发射器推送流式数据
- 渲染进程通过 `on()` 监听并实时渲染

## 数据库设计

### 实体关系图

```mermaid
erDiagram
    feeds ||--o{ articles : "包含"
    articles ||--o{ highlights : "拥有"
    articles }o--o{ tags : "关联 (article_tags)"
    highlights }o--o{ tags : "关联 (highlight_tags)"
    books ||--o{ highlights : "拥有"
    articles ||--o| transcripts : "拥有"
    articles ||--o{ downloads : "关联"
    chat_sessions ||--o{ chat_messages : "包含"

    feeds {
        integer id PK
        text url UK
        text title
        text description
        text favicon
        text category
        integer fetchInterval
        text lastFetchedAt
        integer errorCount
        integer pinned
        text feedType
    }

    articles {
        integer id PK
        integer feedId FK
        text guid UK
        text url
        text title
        text author
        text content
        text contentText
        integer wordCount
        integer readingTime
        text readStatus
        real readProgress
        integer isShortlisted
        text source
        text mediaType
        text videoId
        text audioUrl
        integer audioDuration
    }

    highlights {
        integer id PK
        integer articleId FK
        integer bookId FK
        text text
        text note
        text color
        integer startOffset
        integer endOffset
        text anchorPath
        integer paragraphIndex
    }

    tags {
        integer id PK
        text name UK
    }

    books {
        integer id PK
        text title
        text author
        text cover
        text filePath
        text fileType
        text readStatus
        real readProgress
        text currentLocation
    }

    transcripts {
        integer id PK
        integer articleId FK
        text segments
        text speakerMap
        text language
    }

    chat_sessions {
        integer id PK
        text title
        integer articleId
        text type
    }

    chat_messages {
        integer id PK
        integer sessionId FK
        text role
        text content
        text toolCalls
        text toolResults
    }

    ai_prompt_presets {
        integer id PK
        text name
        text prompt
        text category
        integer sortOrder
        integer isBuiltin
    }

    ai_task_logs {
        integer id PK
        text taskType
        text status
        text input
        text output
        integer tokens
        integer durationMs
    }

    downloads {
        integer id PK
        integer articleId FK
        text url
        text filePath
        text status
        integer progress
    }
```

### 核心表说明

| 表名 | 用途 | 记录数量级 |
|------|------|-----------|
| `feeds` | RSS/播客订阅源 | 百级 |
| `articles` | 文章/视频/播客条目 | 万级 |
| `highlights` | 高亮标注 | 千级 |
| `tags` | 标签 | 百级 |
| `article_tags` | 文章-标签关联 | 千级 |
| `highlight_tags` | 高亮-标签关联 | 千级 |
| `books` | 电子书 | 百级 |
| `transcripts` | 转录文本 | 百级 |
| `downloads` | 下载记录 | 百级 |
| `chat_sessions` | AI 聊天会话 | 百级 |
| `chat_messages` | AI 聊天消息 | 千级 |
| `ai_prompt_presets` | AI 预设模板 | 十级 |
| `ai_task_logs` | AI 任务日志 | 千级 |
| `views` | 自定义视图 | 十级 |

## IPC 通信架构

### 通道分类

Z-Reader 定义了 **60+ IPC 通道**，按功能域分组：

```mermaid
graph LR
    subgraph IPC["IPC 通道 (60+)"]
        Feed["Feed 通道<br/>feedAdd/List/Update/Delete<br/>feedFetch/FetchAll/ImportOpml"]
        Article["Article 通道<br/>articleList/Get/Update/Delete<br/>articleSearch/BatchUpdate<br/>articleSaveUrl/ImportLocal"]
        Highlight["Highlight 通道<br/>highlightList/Create/Delete<br/>highlightUpdate/Export"]
        Tag["Tag 通道<br/>tagList/Create/Delete<br/>articleTagAdd/Remove"]
        Book["Book 通道<br/>bookList/Get/Import/Delete<br/>bookUpdate/ReadFile"]
        AI["AI 通道<br/>aiSettings/PromptPreset<br/>aiSummarize/Translate<br/>aiChatSend/Session"]
        ASR["ASR 通道<br/>asrStart/Cancel<br/>asrProgress/Segment<br/>asrComplete/Error"]
        Sync["Sync 通道<br/>syncStatus/Enable<br/>syncNow/Devices"]
        Other["其他通道<br/>discover/podcast/download<br/>settings/notification/export<br/>shareCard/newsletter"]
    end
```

### 通信模式

| 模式 | 用途 | 方法 |
|------|------|------|
| **请求-响应** | 数据 CRUD | `invoke()` / `handle()` |
| **事件推送** | 流式输出 | `send()` / `on()` |
| **事件取消订阅** | 防止内存泄漏 | `on()` 返回 `unsubscribe` 函数 |

## 关键设计决策

### 1. SQLite + Drizzle ORM
- **决策**：使用 SQLite 作为唯一数据源，Drizzle ORM 提供类型安全
- **理由**：本地优先架构要求低延迟、离线可用；Drizzle 提供编译时类型检查
- **权衡**：牺牲了云端实时同步的便利性，换取完全的数据控制权和离线体验

### 2. IPC 通道化通信
- **决策**：每个功能域独立的 IPC 处理器模块
- **理由**：职责分离清晰，便于维护和测试
- **权衡**：处理器数量多（20+），需要严格的命名规范

### 3. 多阅读器实现
- **决策**：为 HTML/EPUB/PDF/视频/播客各自实现专用阅读器
- **理由**：每种格式的交互模式差异巨大，统一抽象成本过高
- **权衡**：代码量增大，但每个阅读器可以针对性优化

### 4. AI 工具调用模式
- **决策**：AI 通过工具定义与数据库交互
- **理由**：提供结构化的 AI 访问控制，防止意外数据修改
- **权衡**：工具注册和上下文维护增加了复杂度

### 5. 基于文件的 iCloud 同步
- **决策**：通过 iCloud Drive 文件系统进行增量同步
- **理由**：利用 Apple 已有的基础设施，无需自建同步服务器
- **权衡**：依赖 iCloud 生态，非 Apple 用户无法使用

## 模块概览

### 主进程模块

| 模块 | 核心职责 | 关键文件 |
|------|---------|---------|
| **数据库层** | Schema 定义、连接管理 | `schema.ts`, `index.ts` |
| **IPC 层** | 请求路由与处理 | 20+ handler 文件 |
| **RSS 服务** | 订阅抓取与解析 | `rss-service.ts` |
| **解析服务** | 正文提取与统计 | `parser-service.ts`, `text-stats.ts` |
| **YouTube 服务** | 视频流与字幕 | `youtube-service.ts` |
| **播客服务** | 播客搜索与解析 | `podcast-resolver.ts`, `podcast-directory-service.ts` |
| **同步引擎** | iCloud 多设备同步 | `sync/` 目录 8 个文件 |
| **ASR 服务** | 语音转文字 | `asr/` 目录 + `audio-pipeline.ts` |
| **AI 模块** | LLM 集成与工具 | `src/ai/` 14 个文件 |
| **API 服务器** | REST API 暴露 | `api-server.ts` |

### 渲染进程模块

| 模块 | 核心职责 | 关键组件 |
|------|---------|---------|
| **布局** | 三栏交互 | `Sidebar`, `ContentList`, `DetailPanel` |
| **阅读器** | 多格式阅读 | `ReaderView`, `EpubReader`, `PdfReader`, `VideoReaderView`, `PodcastReaderView` |
| **对话框** | 表单与设置 | `AddFeedDialog`, `PreferencesDialog` |
| **功能** | 搜索/AI/下载 | `CommandPalette`, `ChatPanel`, `SearchPanel` |
| **发现** | 内容源发现 | `DiscoverPage`, `FeedPreview` |
| **分享** | 卡片生成 | `ShareCardModal`, 5 种主题 |
| **通用** | 基础交互 | `ArticleCard`, `TagPicker`, `Toast` |
