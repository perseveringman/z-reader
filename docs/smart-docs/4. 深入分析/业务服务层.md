# 深入分析：业务服务层

## 概述

业务服务层位于主进程中，是 Z-Reader 的核心逻辑所在。它处理 RSS 抓取、内容解析、播客/视频管理、下载、同步等所有后端业务。

## 服务全景

```mermaid
graph TB
    subgraph ContentIngestion["内容摄入服务"]
        RSSService["rss-service.ts (15KB)<br/>RSS/Atom 抓取与解析"]
        ParserService["parser-service.ts<br/>正文提取"]
        TextStats["text-stats.ts<br/>阅读时间/字数统计"]
        ArticleStats["article-text-stats.ts<br/>文章统计回填"]
        RSSDiscovery["rss-discovery.ts<br/>RSS 自动发现"]
    end

    subgraph MediaServices["媒体服务"]
        YouTubeService["youtube-service.ts (14KB)<br/>YouTube 视频处理"]
        YouTubeAuth["youtube-auth.ts<br/>YouTube OAuth"]
        PodcastResolver["podcast-resolver.ts (12KB)<br/>播客订阅解析"]
        PodcastDirectory["podcast-directory-service.ts<br/>播客目录搜索"]
        TranscriptionService["transcription-source-service.ts (9KB)<br/>转录处理"]
        LocalMediaImport["local-media-import.ts<br/>本地文件导入"]
        EpubMetadata["epub-metadata.ts<br/>EPUB 元数据"]
    end

    subgraph InfraServices["基础设施服务"]
        DownloadService["download-service.ts<br/>下载管理"]
        SettingsService["settings-service.ts<br/>设置持久化"]
        NotificationService["notification-service.ts<br/>通知管理"]
        TaskService["task-service.ts<br/>后台任务"]
        NewsletterService["newsletter-service.ts<br/>Newsletter 邮件"]
        RSSHubService["rsshub-service.ts<br/>RSSHub 集成"]
        APIServer["api-server.ts (12KB)<br/>REST API 服务器"]
    end

    subgraph SyncServices["同步服务"]
        SyncEngine["sync-engine.ts (7KB)"]
        ChangeTracker["change-tracker.ts"]
        ChangelogWriter["changelog-writer.ts"]
        ChangelogReader["changelog-reader.ts"]
        MergeStrategy["merge-strategy.ts"]
        SnapshotManager["snapshot-manager.ts"]
        DeviceIdentity["device-identity.ts"]
        iCloudDetector["icloud-detector.ts"]
    end

    subgraph ASRServices["语音识别服务"]
        ASRProvider["asr-provider.ts<br/>基础接口"]
        VolcProvider["volcengine-provider.ts"]
        TencentProvider["tencent-provider.ts"]
        AudioPipeline["audio-pipeline.ts"]
        StandardASR["standard-asr-service.ts (5KB)"]
    end

    style ContentIngestion fill:#1E40AF,color:#fff
    style MediaServices fill:#7C3AED,color:#fff
    style InfraServices fill:#047857,color:#fff
    style SyncServices fill:#B45309,color:#fff
    style ASRServices fill:#DC2626,color:#fff
```

## 内容摄入服务

### rss-service.ts - RSS 抓取引擎

Z-Reader 的核心服务，负责所有 RSS/Atom 内容的获取和解析。

```mermaid
flowchart TB
    Start["开始抓取"]
    CheckEtag["检查 ETag / Last-Modified"]
    Fetch["HTTP 请求 RSS XML"]
    Parse["rss-parser 解析"]
    DetectType["检测内容类型"]

    subgraph TypeDetection["类型检测"]
        IsPodcast["播客?<br/>(itunes:* 命名空间)"]
        IsYouTube["YouTube?<br/>(yt:videoId)"]
        IsArticle["普通文章"]
    end

    Extract["提取元数据"]
    Dedup["按 guid 去重"]
    Save["保存到 articles 表"]

    Start --> CheckEtag
    CheckEtag -->|未变更| Skip["跳过抓取"]
    CheckEtag -->|有更新| Fetch
    Fetch --> Parse --> DetectType
    DetectType --> TypeDetection
    TypeDetection --> Extract --> Dedup --> Save
```

**核心功能：**

| 方法 | 说明 |
|------|------|
| `parseFeed(url, etag, lastModified)` | 解析单个 RSS/Atom 源 |
| `fetchFeed(feedId)` | 抓取并更新单个订阅源 |
| `fetchAllFeeds()` | 抓取所有订阅源 |
| `startScheduledFetch(interval)` | 启动定时抓取（默认 15 分钟） |
| `backfillMissingContent()` | 回填缺失的文章正文 |

**自定义字段处理：**

| 字段 | 说明 | 来源 |
|------|------|------|
| `content:encoded` | 完整 HTML 正文 | RSS 2.0 |
| `yt:videoId` | YouTube 视频 ID | YouTube RSS |
| `itunes:duration` | 播客时长 | iTunes RSS |
| `itunes:image` | 播客封面 | iTunes RSS |
| `itunes:season` | 季号 | iTunes RSS |
| `itunes:episode` | 集号 | iTunes RSS |

### parser-service.ts - 正文提取

使用 `@postlight/parser` 从原始 HTML 中提取结构化文章内容：

```mermaid
flowchart LR
    URL["原文 URL"]
    Fetch["获取 HTML"]
    Readability["Readability 算法"]
    Clean["清理 HTML"]
    PlainText["提取纯文本"]
    Stats["计算字数/阅读时间"]

    URL --> Fetch --> Readability --> Clean --> PlainText --> Stats
```

### text-stats.ts - 阅读统计

根据文本内容计算阅读指标：
- 字数统计（中文按字符，英文按空格分词）
- 阅读时间估算（中文 300 字/分钟，英文 250 词/分钟）

## 媒体服务

### youtube-service.ts - YouTube 集成

```mermaid
flowchart TB
    VideoURL["YouTube URL"]
    ExtractID["提取视频 ID"]
    FetchInfo["获取视频信息<br/>(youtubei.js)"]
    Formats["解析可用格式"]

    subgraph QualityOptions["清晰度选项"]
        Q4K["4K"]
        Q1080["1080p"]
        Q720["720p"]
        Q480["480p"]
        QAudio["纯音频"]
    end

    SelectFormat["用户选择格式"]
    Stream["获取视频流"]

    VideoURL --> ExtractID --> FetchInfo --> Formats --> QualityOptions
    QualityOptions --> SelectFormat --> Stream
```

**功能：**
- 视频信息获取（标题、时长、缩略图）
- 多清晰度流提取
- 字幕/转录获取
- OAuth 认证（年龄限制内容）

### podcast-resolver.ts - 播客解析

```mermaid
flowchart TB
    Input["播客源 URL / 搜索关键词"]

    subgraph Search["搜索播客"]
        iTunes["iTunes Search API"]
        PodcastIndex["PodcastIndex API"]
    end

    FeedURL["获取 RSS Feed URL"]
    Parse["解析播客 RSS"]
    Episodes["提取集列表"]
    Metadata["提取节目元数据<br/>(封面/作者/描述)"]
    Save["保存为 articles<br/>(mediaType: podcast)"]

    Input --> Search --> FeedURL --> Parse
    Parse --> Episodes --> Save
    Parse --> Metadata
```

### transcription-source-service.ts - 转录服务

管理音视频转录的完整流程：

```mermaid
flowchart TB
    Source["音频/视频源"]
    Check["检查已有转录"]
    Extract["提取音频<br/>(ffmpeg)"]
    ASR["语音识别"]
    Segments["时间码片段"]
    Speaker["说话人标记"]
    Save["保存到 transcripts 表"]

    Source --> Check
    Check -->|已有| Return["返回缓存"]
    Check -->|无| Extract --> ASR --> Segments --> Speaker --> Save
```

## 同步服务

### iCloud 同步架构

```mermaid
graph TB
    subgraph DeviceA["设备 A"]
        AppA["Z-Reader 应用"]
        DBA["本地 SQLite"]
        TrackerA["变更追踪器"]
    end

    subgraph SyncLayer["同步层"]
        SyncEngineA["同步引擎"]
        WriterA["Changelog 写入器"]
        ReaderA["Changelog 读取器"]
        MergerA["合并策略"]
    end

    subgraph iCloudDrive["iCloud Drive"]
        DeviceADir["设备 A 目录/<br/>changelog-*.json"]
        DeviceBDir["设备 B 目录/<br/>changelog-*.json"]
        SnapshotDir["快照目录/<br/>snapshot-*.json"]
    end

    AppA -->|数据变更| TrackerA
    TrackerA --> SyncEngineA
    SyncEngineA --> WriterA -->|push| DeviceADir
    SyncEngineA --> ReaderA -->|pull| DeviceBDir
    ReaderA --> MergerA -->|合并变更| DBA

    style DeviceA fill:#1E40AF,color:#fff
    style SyncLayer fill:#B45309,color:#fff
    style iCloudDrive fill:#6B7280,color:#fff
```

**同步组件职责：**

| 组件 | 职责 |
|------|------|
| `sync-engine.ts` | 编排 push/pull 全流程 |
| `change-tracker.ts` | 追踪每次 CRUD 操作的变更 |
| `changelog-writer.ts` | 将变更序列化为 JSON 文件 |
| `changelog-reader.ts` | 读取其他设备的变更文件 |
| `merge-strategy.ts` | 基于时间戳的冲突解决 |
| `snapshot-manager.ts` | 定期创建数据快照 |
| `device-identity.ts` | 生成唯一设备 ID |
| `icloud-detector.ts` | 检测 iCloud Drive 路径 |

**冲突解决策略：**
1. 以 `updatedAt` 时间戳最新的记录为准
2. 创建操作优先于删除操作
3. 字段级合并（非整条记录覆盖）

## ASR 语音识别服务

```mermaid
graph TB
    subgraph ASRSystem["ASR 系统"]
        AudioPipeline["音频管线<br/>(ffmpeg 提取/转码)"]
        ASRProvider["ASR 供应商接口"]

        subgraph Providers["供应商实现"]
            Volc["火山引擎<br/>volcengine-provider"]
            Tencent["腾讯云<br/>tencent-provider"]
        end

        StandardASR["标准 ASR 服务<br/>(文件识别)"]
    end

    Audio["音频文件"] --> AudioPipeline
    AudioPipeline --> ASRProvider
    ASRProvider --> Providers
    StandardASR --> ASRProvider

    style ASRSystem fill:#DC2626,color:#fff
```

**支持模式：**
- **实时识别**：流式推送音频片段，逐句返回结果
- **标准识别**：上传完整音频文件，批量返回结果

## 基础设施服务

### api-server.ts - REST API

提供 HTTP API 供外部应用（如 Chrome 扩展）访问：

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/articles` | GET | 获取文章列表 |
| `/api/articles/:id` | GET | 获取单篇文章 |
| `/api/articles` | POST | 保存文章 |
| `/api/feeds` | GET | 获取订阅列表 |
| `/api/highlights` | POST | 创建高亮 |

### newsletter-service.ts - Newsletter 集成

```mermaid
flowchart LR
    Generate["生成唯一邮箱地址"]
    Subscribe["订阅 Newsletter"]
    Receive["接收邮件"]
    Convert["转换为 Atom Feed"]
    Import["导入为文章"]

    Generate --> Subscribe --> Receive --> Convert --> Import
```

### rsshub-service.ts - RSSHub 集成

与 RSSHub 服务交互，提供丰富的 RSS 源发现：
- 查询 RSSHub 可用路由
- 按分类浏览源
- 生成自定义 RSS URL
- 预览 Feed 内容

## 服务间依赖关系

```mermaid
graph LR
    RSS["rss-service"] --> Parser["parser-service"]
    RSS --> TextStats["text-stats"]
    RSS --> DB["数据库"]
    YouTube["youtube-service"] --> DB
    Podcast["podcast-resolver"] --> RSS
    Podcast --> PodDir["podcast-directory"]
    Transcription["transcription-service"] --> ASR["ASR 服务"]
    Transcription --> AudioPipe["audio-pipeline"]
    Sync["sync-engine"] --> Tracker["change-tracker"]
    Sync --> Writer["changelog-writer"]
    Sync --> Reader["changelog-reader"]
    Sync --> Merger["merge-strategy"]
    Newsletter["newsletter-service"] --> DB
    Download["download-service"] --> DB
    APIServer["api-server"] --> DB

    style DB fill:#F59E0B,color:#000
```

## 潜在改进

1. **服务抽象层**：引入依赖注入容器，解耦服务间依赖
2. **重试机制**：RSS 抓取失败时的指数退避重试
3. **缓存层**：热点数据内存缓存，减少数据库查询
4. **任务队列**：后台任务统一队列管理
5. **健康检查**：服务状态监控与自动恢复
6. **日志系统**：结构化日志，便于问题排查
