"use strict";(()=>{var p={yellow:"#fef08a",blue:"#93c5fd",green:"#86efac",red:"#fca5a5"};var f="data-zr-highlight-id",H="zr-highlight";function y(t="yellow"){let e=window.getSelection();if(!e||e.isCollapsed||!e.rangeCount)return null;let n=e.getRangeAt(0),r=e.toString().trim();if(!r)return null;let c=n.startContainer.parentElement,a=L(c),o=n.startOffset,g=n.endOffset,i=R(),l=v(i,t);try{n.surroundContents(l)}catch{let s=n.extractContents();l.appendChild(s),n.insertNode(l)}return e.removeAllRanges(),E(l),{text:r,startOffset:o,endOffset:g,paragraphIndex:a,updateId:s=>{l.setAttribute(f,s)}}}function w(t,e,n){let r=document.body,c=document.createTreeWalker(r,NodeFilter.SHOW_TEXT),a;for(;a=c.nextNode();){let o=a,i=(o.textContent??"").indexOf(e);if(i===-1||o.parentElement?.classList.contains(H))continue;let l=document.createRange();l.setStart(o,i),l.setEnd(o,i+e.length);let s=v(t,n);try{l.surroundContents(s)}catch{let k=l.extractContents();s.appendChild(k),l.insertNode(s)}return E(s),!0}return!1}function I(t){document.querySelectorAll(`[${f}="${t}"]`).forEach(n=>{let r=n.parentNode;if(r){for(;n.firstChild;)r.insertBefore(n.firstChild,n);r.removeChild(n),r.normalize()}})}function v(t,e){let n=document.createElement("mark");return n.className=H,n.setAttribute(f,t),n.style.backgroundColor=p[e],n.style.borderRadius="2px",n.style.padding="0 1px",n.style.cursor="pointer",n}function E(t){t.addEventListener("click",()=>{let e=t.getAttribute(f),n=t.textContent;document.dispatchEvent(new CustomEvent("zr-highlight-click",{detail:{id:e,text:n}}))})}function L(t){if(!t)return 0;let e=t.closest("p, div, li, h1, h2, h3, h4, h5, h6, blockquote, td, th, pre");if(!e)return 0;let n=document.querySelectorAll("p, div, li, h1, h2, h3, h4, h5, h6, blockquote, td, th, pre");for(let r=0;r<n.length;r++)if(n[r]===e)return r;return 0}function R(){return`zr_${Date.now()}_${Math.random().toString(36).slice(2,8)}`}var b="zr-highlight-toolbar",d=null;function T(t,e,n){u(),d=n;let r=document.createElement("div");r.id=b,["yellow","blue","green","red"].forEach(i=>{let l=document.createElement("button");l.className="zr-toolbar-btn zr-color-btn",l.style.backgroundColor=p[i],l.title=`${i} \u9AD8\u4EAE`,l.addEventListener("click",s=>{s.stopPropagation(),d?.({type:"highlight",color:i}),u()}),r.appendChild(l)});let a=document.createElement("span");a.className="zr-toolbar-divider",r.appendChild(a);let o=document.createElement("button");o.className="zr-toolbar-btn zr-action-btn",o.textContent="\u{1F4DD}",o.title="\u6DFB\u52A0\u7B14\u8BB0",o.addEventListener("click",i=>{i.stopPropagation(),d?.({type:"note"}),u()}),r.appendChild(o);let g=document.createElement("button");g.className="zr-toolbar-btn zr-action-btn",g.textContent="\u{1F4BE}",g.title="\u4FDD\u5B58\u5230 Z-Reader",g.addEventListener("click",i=>{i.stopPropagation(),d?.({type:"save"}),u()}),r.appendChild(g),r.style.left=`${t}px`,r.style.top=`${e-50}px`,document.body.appendChild(r),requestAnimationFrame(()=>{let i=r.getBoundingClientRect();i.right>window.innerWidth&&(r.style.left=`${window.innerWidth-i.width-8}px`),i.left<0&&(r.style.left="8px"),i.top<0&&(r.style.top=`${e+20}px`)})}function u(){let t=document.getElementById(b);t&&t.remove(),d=null}document.addEventListener("mousedown",t=>{let e=document.getElementById(b);e&&!e.contains(t.target)&&u()});var $="http://127.0.0.1:21897/api";async function m(t,e){let n=`${$}${t}`,r=await fetch(n,{headers:{"Content-Type":"application/json"},...e});if(!r.ok){let c=await r.text().catch(()=>"\u672A\u77E5\u9519\u8BEF");throw new Error(`API \u8BF7\u6C42\u5931\u8D25 [${r.status}]: ${c}`)}return r.json()}async function A(t){return m("/articles",{method:"POST",body:JSON.stringify(t)})}async function O(t){return m(`/highlights?url=${encodeURIComponent(t)}`)}async function x(t){return m("/highlights",{method:"POST",body:JSON.stringify(t)})}async function S(t){await m(`/highlights/${t}`,{method:"DELETE"})}var h=null;async function N(){try{let t=await O(window.location.href);if(t.articleId){h=t.articleId;for(let e of t.highlights)w(e.id,e.text??"",e.color??"yellow")}}catch{}}document.addEventListener("mouseup",()=>{let t=window.getSelection();!t||t.isCollapsed||!t.toString().trim()||requestAnimationFrame(()=>{let e=window.getSelection();if(!e||e.isCollapsed)return;let r=e.getRangeAt(0).getBoundingClientRect(),c=r.left+r.width/2+window.scrollX,a=r.top+window.scrollY;T(c,a,async o=>{o.type==="highlight"?await P(o.color):o.type==="save"?await z():o.type==="note"&&await B()})})});async function C(){if(h)return!0;try{return h=(await A({url:window.location.href,title:document.title})).id,!0}catch(t){return console.error("[Z-Reader] \u4FDD\u5B58\u6587\u7AE0\u5931\u8D25:",t),!1}}async function P(t){let e=y(t);if(e&&await C())try{let n=await x({articleId:h,text:e.text,color:t,startOffset:e.startOffset,endOffset:e.endOffset,paragraphIndex:e.paragraphIndex});e.updateId(n.id)}catch(n){console.error("[Z-Reader] \u521B\u5EFA\u9AD8\u4EAE\u5931\u8D25:",n)}}async function z(){await C()}async function B(){let t=prompt("\u8F93\u5165\u7B14\u8BB0:");if(t===null)return;let e=y("yellow");if(e&&await C())try{let n=await x({articleId:h,text:e.text,note:t,color:"yellow",startOffset:e.startOffset,endOffset:e.endOffset,paragraphIndex:e.paragraphIndex});e.updateId(n.id)}catch(n){console.error("[Z-Reader] \u521B\u5EFA\u5E26\u7B14\u8BB0\u9AD8\u4EAE\u5931\u8D25:",n)}}document.addEventListener("zr-highlight-click",t=>{let e=t.detail;e?.id&&confirm("\u662F\u5426\u5220\u9664\u6B64\u9AD8\u4EAE\uFF1F")&&(I(e.id),S(e.id).catch(n=>{console.error("[Z-Reader] \u5220\u9664\u9AD8\u4EAE\u5931\u8D25:",n)}))});chrome.runtime.onMessage.addListener(t=>{t.type==="ARTICLE_SAVED"&&(h=t.payload.id)});N();})();
