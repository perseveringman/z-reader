var a="http://127.0.0.1:21897/api";async function s(e,r){let i=`${a}${e}`,t=await fetch(i,{headers:{"Content-Type":"application/json"},...r});if(!t.ok){let o=await t.text().catch(()=>"\u672A\u77E5\u9519\u8BEF");throw new Error(`API \u8BF7\u6C42\u5931\u8D25 [${t.status}]: ${o}`)}return t.json()}async function n(e){return s("/articles",{method:"POST",body:JSON.stringify(e)})}async function h(e){return s(`/highlights?url=${encodeURIComponent(e)}`)}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"save-to-zreader",title:"\u{1F4BE} \u4FDD\u5B58\u5230 Z-Reader",contexts:["page"]}),chrome.contextMenus.create({id:"highlight-parent",title:"\u{1F58D}\uFE0F Z-Reader \u9AD8\u4EAE",contexts:["selection"]}),chrome.contextMenus.create({id:"highlight-yellow",parentId:"highlight-parent",title:"\u{1F7E1} \u9EC4\u8272\u9AD8\u4EAE",contexts:["selection"]}),chrome.contextMenus.create({id:"highlight-blue",parentId:"highlight-parent",title:"\u{1F535} \u84DD\u8272\u9AD8\u4EAE",contexts:["selection"]}),chrome.contextMenus.create({id:"highlight-green",parentId:"highlight-parent",title:"\u{1F7E2} \u7EFF\u8272\u9AD8\u4EAE",contexts:["selection"]}),chrome.contextMenus.create({id:"highlight-red",parentId:"highlight-parent",title:"\u{1F534} \u7EA2\u8272\u9AD8\u4EAE",contexts:["selection"]}),chrome.contextMenus.create({id:"separator-1",parentId:"highlight-parent",type:"separator",contexts:["selection"]}),chrome.contextMenus.create({id:"highlight-with-note",parentId:"highlight-parent",title:"\u{1F4DD} \u6DFB\u52A0\u7B14\u8BB0\u9AD8\u4EAE",contexts:["selection"]}),chrome.contextMenus.create({id:"search-in-zreader",parentId:"highlight-parent",title:"\u{1F50D} \u5728 Z-Reader \u4E2D\u641C\u7D22",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener(async(e,r)=>{if(!r?.id||!r.url)return;if(e.menuItemId==="save-to-zreader")try{let t=await n({url:r.url,title:r.title});chrome.tabs.sendMessage(r.id,{type:"ARTICLE_SAVED",payload:t}),chrome.tabs.sendMessage(r.id,{type:"SHOW_TOAST",payload:{message:"\u6587\u7AE0\u5DF2\u4FDD\u5B58\u5230 Z-Reader",type:"success"}})}catch(t){console.error("\u4FDD\u5B58\u6587\u7AE0\u5931\u8D25:",t),chrome.tabs.sendMessage(r.id,{type:"SHOW_TOAST",payload:{message:"\u4FDD\u5B58\u6587\u7AE0\u5931\u8D25",type:"error"}})}let i={"highlight-yellow":"yellow","highlight-blue":"blue","highlight-green":"green","highlight-red":"red"};e.menuItemId&&i[e.menuItemId]&&chrome.tabs.sendMessage(r.id,{type:"HIGHLIGHT_SELECTION",payload:{color:i[e.menuItemId]}}),e.menuItemId==="highlight-with-note"&&chrome.tabs.sendMessage(r.id,{type:"HIGHLIGHT_WITH_NOTE"}),e.menuItemId==="search-in-zreader"&&e.selectionText&&chrome.tabs.sendMessage(r.id,{type:"SEARCH_IN_ZREADER",payload:{text:e.selectionText}})});chrome.runtime.onMessage.addListener((e,r,i)=>{if(e.type==="GET_HIGHLIGHTS_BY_URL")return h(e.payload.url).then(t=>i({success:!0,data:t})).catch(t=>i({success:!1,error:t.message})),!0;if(e.type==="SAVE_ARTICLE")return n(e.payload).then(t=>i({success:!0,data:t})).catch(t=>i({success:!1,error:t.message})),!0});
